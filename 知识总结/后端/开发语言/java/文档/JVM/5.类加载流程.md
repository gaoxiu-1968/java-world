# 类加载流程

> 类加载就是把Class文件加载到内存

加载的过程一共可以分为5个部分：加载，验证，准备，解析，初始化。

## 具体流程

### 加载

加载阶段，虚拟机主要完成下面几点：

1.通过一个类的全限定名来获取定义此类的二进制字节流。

2.将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构。

3.在内存中生成一个代表这个类的java.lang.Class对象，作为方法区这个类的各种数据的访问入口。

### 验证

验证是连接阶段的第一步，这个阶段的目的是为了确保Class文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机自身的安全。

验证阶段大致上会完成下面4个阶段的验证动作：文件格式验证，元数据验证，字节码验证，符号引用验证。

### 准备

准备阶段是正式为类变量（static修饰的变量）分配内存并设置类变量初始值的阶段，这些变量所使用的内存都将在方法区分配。

### 解析

解析阶段是虚拟机将常量池内的符号引用替换为直接引用的过程。

主要目的是为了提供动态加载的能力。

符号引用可以看做是一个标识，引用的目标不一定已经记载到内存。

直接引用指向实际的内存地址。

### 初始化

在准备阶段，变量已经赋过一次系统要求的初始值，而在初始化阶段，则根据程序员的主观计划去初始化变量和其他资源。

## 类加载器

* 什么是类加载器？

虚拟机设计团队把类加载阶段中的“通过一个类的全限定名来获取描述此类的二进制字节流”这个动作放到了java虚拟机外部去实现，以便让应用程序自己去决定如何去获取所需要的类，实现这个动作的代码模块称为类加载器。

* 类加载器一共有几种？

4种

1.启动类加载器

2.扩展类加载器

3.应用程序类加载器

4.自定义类加载器

### 双亲委派模型

![image-20210924162510744](img/image-20210924162510744.png)

#### 原理

如果一个类加载器接受到类加载请求，它首先不会自己尝试加载这个类，而是把这个请求委派给父类加载器去完成，每一个层次的加载器都是这样，因此所有的加载请求最终都应该传送到顶层的启动类加载器中，只有当父加载器反馈自己无法完成这个加载请求（它的搜索范围中没有找到所需的类）时，子加载器才会尝试自己去加载。

#### 破坏双亲委派模型

三次大规模的破坏：

​	第一次：兼容jdk1.2之前的代码

​	第二次：双亲委派模型自身的缺陷

​	第三次：用户对程序动态性的追求